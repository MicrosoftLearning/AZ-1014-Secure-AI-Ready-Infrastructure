# AI Ready Manage hands-on exercise: Implement Microsoft Foundry standard agent setup

## Background information
Foundry Agent Service enables creating AI agents through a two-step flow: first establishing an agent environment, and then creating and configuring the agent using an SDK or the Azure Foundry portal.

Agents are always created within a Foundry project, which functions as an isolated workspace. Agents within the same project share access to file storage, conversation history, and search indexes. Data is isolated across projects, and agents cannot access resources outside their own project. Projects are the unit of sharing and isolation within Foundry.

Foundry supports three environment configuration modes that balance speed, control, and security:
- Basic setup prioritizes rapid onboarding and uses platform-managed storage for agent state. It is compatible with OpenAI Assistants and provides the same core tools and capabilities, with added support for non-OpenAI models and integrations such as Azure AI Search and Bing.
- Standard setup builds on the Basic setup by using customer-owned Azure resources for all agent data. This provides full ownership and control over files, conversation history, and vector data, and supports enterprise compliance and governance requirements.
- Standard setup with network isolation extends the Standard setup by allowing the environment to operate entirely within a customer-managed virtual network, enabling strict control over data movement and enhanced protection against data exfiltration.

The Standard agent environment is designed for enterprise-grade security, compliance, and data governance. All agent state is stored in customer-owned Azure resources, specifically Azure Storage for file uploads and intermediate system data, Azure AI Search for vector indexes used in search and retrieval, and Azure Cosmos DB for NoSQL for conversation history, system messages, and agent metadata. This ensures that all data generated during agent configuration and user interaction remains fully under the customerâ€™s control.

Standard setup supports private network isolation by using the Bring Your Own Virtual Network (BYO VNet) approach, also known as custom VNet support with subnet delegation. This implementation gives you full control over the inbound and outbound communication paths for agents. You can restrict access to only the resources explicitly required by these agents, such as storage accounts, databases, or APIs, while blocking all other traffic by default. This approach ensures that the agents operate within a tightly scoped network boundary, reducing the risk of data leakage or unauthorized access. By default, this setup simplifies security configuration while enforcing strong isolation guarantees, ensuring that each agent deployment remains secure, compliant, and aligned with enterprise networking policies.

Provisioning standard environments is not available directly from the Microsoft Foundry portal, but you can implement them either programmatically or via deployment templates. Sample Azure Resource Manager and Bicep templates are available from the [foundry-samples GitHub repository](https://github.com/azure-ai-foundry/foundry-samples/tree/main/infrastructure/infrastructure-setup-bicep/15-private-network-standard-agent-setup). They allow you to automatically create a Foundry account and project, deploy a model, and configure authentication using Managed Identity. With the Standard configuration option, you can deploy a network-secured Azure AI agent environment with private networking and role-based access control (RBAC).

In preparation for the template-based deployment, you should take the following steps:
- Create a virtual network with a private IP address space (e.g., 192.168.0.0/16) that does not overlap with those used by your existing on-premises or Azure virtual networks. 
- Create two subnets within the virtual network you implemented in the first step:
   - Agent subnet (e.g., 192.168.0.0/24), which hosts the agent client for agent workloads, delegated to Microsoft.App/environments. Its recommended size is /24.
   - Private endpoint subnet (e.g. 192.168.1.0/24), which hosts private endpoints for BYO resources associated with Microsoft Foundry, such as an Azure Cosmos DB for NoSQL account, an Azure AI Search instance, and an Azure Storage account. 

If you do not reference an existing virtual network as a parameter during deployment, a new virtual network with two subnets will be provisioned automatically for you. In addition, the deployment will include an Azure Cosmos DB for NoSQL account, an Azure AI Search instance, and an Azure Storage account, unless you pre-provision and reference them during deployment.

**Important**: Before deleting the Microsoft Foundry account resource, it is essential to first delete the associated Capability Host. Failure to do so may result in residual dependencies, including subnets and other provisioned resources, remaining linked to the capability host. This can lead to errors such as *Subnet already in use* when attempting to reuse the same subnet in a different account deployment.

There are two cleanup options:
- Full account removal: To completely remove an account, you must delete and purge the account. Simply deleting the account is not sufficient, you must purge so that deletion of the associated capability host is triggered. The service will automatically handle the removal of the capability host and any linked resources in the background. To purge the account, use [Purge a deleted resource instructions](https://learn.microsoft.com/en-us/azure/ai-services/recover-purge-resources?tabs=azure-portal#purge-a-deleted-resource). Make sure to allow approximately max of 20 minutes for all resources to be fully unlinked from the account.
- Retain account but remove Capability Host: If you intend to retain the account but remove the capability host, execute the script [deleteCaphost.sh](https://raw.githubusercontent.com/azure-ai-foundry/foundry-samples/refs/heads/main/infrastructure/infrastructure-setup-bicep/15-private-network-standard-agent-setup/deleteCapHost.sh). After deletion, allow approximately max of 20 minutes for all resources to be fully unlinked from the account. To recreate the capability host for the account, use the script [createCaphost.sh](https://raw.githubusercontent.com/azure-ai-foundry/foundry-samples/refs/heads/main/infrastructure/infrastructure-setup-bicep/15-private-network-standard-agent-setup/createCapHost.sh). 

## Scenario
Your company is building a centralized AI platform on Microsoft Foundry to support enterprise knowledge management and decision support across multiple business units, with a strong emphasis on network isolation and compliance-driven security controls. The platform will enable intelligent document retrieval, automated analysis of internal reports, and conversational insights for employees, while ensuring that all traffic remains within approved network boundaries. To meet these requirements, the team will deploy a Standard agent environment with private networking, integrating the Foundry account and project into an existing customer-managed virtual network that will host agents and private endpoints connecting services associated with the Microsoft Foundry resources. These services will include customer-owned Azure Storage, Azure Cosmos DB, and Azure AI Search instances to be used for storing documents, conversation history, and search indexes without public exposure. The environment will be deployed by using template-based automation.

## Prerequisites
- **Azure subscription**: If you don't have an Azure subscription, [create a free account](https://azure.microsoft.com/free/) before you begin.
- **Permissions**: To create Azure AI Services resources, you should have the Owner role assigned at the Azure subscription.
- **Familiarity with Microsoft Foundry resource types**: To learn more, refer to [Choose an Azure resource type for AI foundry](https://learn.microsoft.com/en-us/azure/ai-foundry/concepts/resource-types).

## Estimated duration
15 minutes

**Important**: The exercise involves provisioning a virtual network with two subnets and reviewing the process of a template-based deployment of a Microsoft Foundry standard agent environment with private networking, without the actual implementation of such environment. This is intentional in order to minimize the duration and cost of the exercise. There are additional considerations associated with the deprovisioning process, which would further increase the cost and complexity of the implementation tasks. 

### Task 1: Provision an Azure virtual network for Microsoft Foundry standard agent environment with private networking

1. Start a web browser, navigate to the Azure portal at [https://portal.azure.com](https://portal.azure.com) and sign in by providing the credentials of a user account which has the Owner role assigned at the Azure subscription level.
1. In the web browser displaying the Azure portal, use the **Search** text box at the top of the page to search for **Virtual networks** and, in the list of results, select **Virtual networks**.
1. On the **Network foundation \| Virtual networks** page, select **+ Create**.
1. On the **Basics** tab of the **Create virtual network** page, specify the following settings (leave others with their default values) and select **Next**:

   |Setting|Value|
   |---|---|
   |Subscription|The name of the Azure subscription you are using in this exercise|
   |Resource group|The name of a new resource group **foundry-standard-vnet-RG**|
   |Virtual network name|**foundry-standard-vnet**|
   |Region|The name of the Azure region which supports Microsoft Foundry standard agent setup|

   >**Note**: For the list of Azure regions to choose from, refer to the values of the **location** parameter in the [**azuredeploy.json**](https://github.com/azure-ai-foundry/foundry-samples/blob/main/infrastructure/infrastructure-setup-bicep/41-standard-agent-setup/azuredeploy.json) Azure Resource Manager template. Verify that you can provision an Azure AI Search instance and Azure Cosmos DB account in the same region.

1. On the **Security** tab, accept the default settings without making any changes and select **Next**:
1. On the **IP addresses** tab, perform the following tasks:

   * In the address space area, replace the default values of **10.0.0.0** and **/16** with **192.168.0.0** and **/20**.
   * Select **+ Add a subnet**.
   * In the **Add a subnet** pane, in the **Name** text box, enter **agent-subnet**, accept the default **Starting address** of **192.168.0.0** and **Size** of **/24 (256 addresses)**, in the **Subnet Delegation** section, in the **Delegate subnet to a service** drop-down list, select **Microsoft.App/environments**, and select **Add**.
   * Select **+ Add a subnet**.
   * In the **Add a subnet**pane, in the **Name** text box, enter **pe-subnet**, accept the default **Starting address** of **192.168.1.0** and **Size** of **/24 (256 addresses)**, and select **Add**.
   * Select **Review + create**.

1. On the **Review + create** tab, wait for the validation process to complete, and then select **Create**.

   >**Note**: Wait for the resource provisioning to complete. This should take less than one minute. 

1. On the **Deployment** page, select **Go to resource**.
1. On the **Overview** page of the newly provisioned storage account, in the upper right corner, select **JSON View**.
1. On the **Resource JSON** pane, select the copy icon in the **Resource ID** text box. 

   >**Note**: Record the value of the Resource ID of the virtual network (for example by pasting it into Notepad). You'll need it later in this exercise.

### Task 2: Review template-based deployment of Microsoft Foundry standard agent environment with private networking

**Important**: Do **not** initiate the deployment, but instead only review the deployment settings. This is intended to minimize the cost and complexity of implementing this exercise.

1. In the web browser displaying the Azure portal, open another tab and browse to the standard agent deployment with private network Bicep template **README.md** page in the [foundry-samples GitHub repository](https://github.com/azure-ai-foundry/foundry-samples/tree/main/infrastructure/infrastructure-setup-bicep/15-private-network-standard-agent-setup/).
1. On the **Azure AI Agent Service: Standard Agent Setup with E2E Network Isolation** page, select **Deploy to Azure**. This will automatically open the **Custom deployment** page in the Azure portal.
1. On the **Custom deployment** page, specify the following settings (leave others with their default values) and then select **Review + create**:

   |Setting|Value|
   |---|---|
   |Subscription|The name of the Azure subscription you are using in this exercise|
   |Resource group|**foundry-standard-vnet-RG**|
   |Region|The name of the same Azure region you specified when provisioning the virtual network earlier in this exercise|
   |Location|The name of the same Azure region you specified when provisioning the virtual network earlier in this exercise|
   |AI Services|**aiservices**|
   |Model Name|**gpt-4o**|
   |Model Format|**OpenAI**|
   |Model Sku Name|**GlobalStandard**|
   |First Project name|**vnetproject**|
   |Project description|**A project for the Microsoft Foundry account with network secured standard agent**|
   |Display Name|**Network secured agent project**|
   |Vnet Name|**foundry-standard-vnet**|
   |Agent Subnet Name|**agent-subnet**|
   |Pe Subnet Name|**pe-subnet**|
   |Existing Vnet Resource Id|The resource id of the pre-provisioned Azure virtual network you recorded earlier in this exercise|

1. On the **Review + create** tab of the **Custom deployment** page, review the configuration settings but **do not** select **Create**.

### Task 3: Perform cleanup

1. In the web browser displaying the Azure portal, use the **Search** text box at the top of the page to search for **foundry-standard-vnet-RG** and, in the list of results, select **foundry-standard-vnet-RG**.
1. On the **foundry-standard-vnet-RG** page, select **Delete resource group**, on the **Delete a resource group** pane, in the **Enter resource group name to confirm deletion** text box, enter **foundry-standard-vnet-RG**, select **Delete**, and, when prompted for confirmation, select **Delete** again.